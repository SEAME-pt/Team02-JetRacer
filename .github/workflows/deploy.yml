name: Build and Deploy

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: true
    
      # Install CMake
      - name: Install CMake
        run: sudo apt-get update && sudo apt-get install -y cmake

      # Install compilers
      - name: Install Compilers
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      # Build CarController
      - name: Build CarController
        run: |
          mkdir -p CarController/build
          cd CarController/build
          cmake -DCMAKE_TOOLCHAIN_FILE=../aarch64-toolchain.cmake ..
          make

      # Build XboxController
      - name: Build XboxController
        run: |
          mkdir -p XboxController/build
          cd XboxController/build
          cmake -DCMAKE_TOOLCHAIN_FILE=../aarch64-toolchain.cmake ..
          make

      # Send CarController to JetRacer
      - name: Send CarController to JetRacer
        run: |
          echo "Sending CarController executable to JetRacer..."
          curl -v -X POST http://10.21.221.71:5000/download_and_run \
            -H "Content-Type: application/json" \
            -d "{\"file_url\": \"https://github.com/SEAME-pt/Team02-PyRacer/raw/main/CarController/CarController\"}"

      # Send XboxController to JetRacer
      - name: Send XboxController to JetRacer
        run: |
          echo "Sending XboxController executable to JetRacer..."
          curl -v -X POST http://10.21.221.71:5000/download_and_run \
            -H "Content-Type: application/json" \
            -d "{\"file_url\": \"https://github.com/SEAME-pt/Team02-PyRacer/raw/23577131a548967f0f1c8627112fbb057098990a/XboxController/XboxController\"}"
